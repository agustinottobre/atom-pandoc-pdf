'use babel'

import PandocPdfProcessor from './pandoc-pdf-processor.js'
import { CompositeDisposable } from 'atom'


export default class PandocPdfView {
  
  
  // get PandocPdfView from active editor, optionally creating it
  static get(create) {
    // get active editor
    const editor = atom.workspace.getActiveTextEditor()
    if (!editor) {
      return undefined
    }
    // is there a Pandoc/PDF view in the editor?
    var ppvElement = editor.element.querySelector('.pandoc-pdf-view')
    if (ppvElement) {
      // if yes, return its PandocPdfView
      return ppvElement.model
    } else {
      // if not, optionally create it
      if (create) {
        return new PandocPdfView(editor)
      } else {
        return undefined
      }
    }
  }
  

  // create PandocPdfView
  constructor(editor) {
    console.log('▶ PandocPdfView constructor')
view = this // HACK
    
    this.subscriptions = new CompositeDisposable()
    
    // create Pandoc processor
    this.processor = new PandocPdfProcessor(editor.getPath())
    
    // create HTML div for view
    this.element = document.createElement('div')
    this.element.classList.add('pandoc-pdf-view')
    this.element.innerHTML = `
      <span class="pandoc-pdf-heading inline-block-tight text-highlight">Pandoc/PDF</span>
      <span class="pandoc-pdf-spacer"></span>
      <span class="inline-block-tight btn icon icon-pandoc"           data-id="process"         title="Process with Pandoc into PDF"></span>
      <span class="inline-block-tight btn icon icon-file-pdf"         data-id="save-pdf"        title="Save Generated PDF"></span>
      <span class="pandoc-pdf-spacer"></span>
      <span class="inline-block-tight btn icon icon-three-bars"       data-id="toggle-log"      title="Toggle Pandoc Log Messages"></span>
      <span class="inline-block-tight btn icon icon-gear"             data-id="open-defaults"   title="Open Source Defaults File in Atom"></span>
      <span class="pandoc-pdf-spacer"></span>
      <span class="inline-block-tight btn icon icon-file-directory"   data-id="show-files"      title="Show Intermediate Files Generated by Pandoc"></span>
      <span class="inline-block-tight btn icon icon-tools"            data-id="show-settings"   title="Show Pandoc/PDF Settings"></span>
      <span class="pandoc-pdf-spacer"></span>
      <span class="inline-block-tight btn icon icon-question"         data-id="show-help"       title="Show Help"></span>
      
      <span class="inline-block-tight pandoc-pdf-close icon icon-x"   data-id="close-view"      title="Close Pandoc/PDF Panel"></span>
      
      <div class="pandoc-pdf-dialog" style="display: none">
        <div>
          <span class="inline-block text-highlight">Pandoc/PDF Log</span>
          <span class="inline-block pandoc-pdf-close icon-x"          data-id="hide-log" title="Hide Pandoc Log Messages"></span>
        </div>
        <div class="pandoc-pdf-log">
        </div>
      </div>
    `
    // add function to buttons
    this.element.querySelector('[data-id="process"]').
      addEventListener('click', (event) => this.process())
    this.element.querySelector('[data-id="save-pdf"]').
      addEventListener('click', (event) => this.processor.savePDF())
    this.element.querySelector('[data-id="toggle-log"]').
      addEventListener('click', (event) => this.showLog())
    this.element.querySelector('[data-id="open-defaults"]').
      addEventListener('click', (event) => this.processor.openDefaults())
    this.element.querySelector('[data-id="show-files"]').
      addEventListener('click', (event) => this.processor.showFiles())
    this.element.querySelector('[data-id="show-settings"]').
      addEventListener('click', (event) => atom.workspace.
       open("atom://config/packages/pandoc-pdf"))
    this.element.querySelector('[data-id="show-help"]').
      addEventListener('click', (event) => atom.workspace.
        open('markdown-preview://' + path.join(__dirname, '..', 'README.md')))
    this.element.querySelector('[data-id="close-view"]').
      addEventListener('click', (event) => this.destroy())
    this.element.querySelector('[data-id="hide-log"]').
      addEventListener('click', (event) => this.showLog(false))
    
    // make this view object accessible from the HTML div
    this.element.model = this

    // remember the associated editor
    this.editor = editor
    
    // add div as first child to editor
    this.editor.element.prepend(this.element)
    
    // fit the absolutely positioned div above the editor
    //   height of div
    const height = this.element.offsetHeight  // account for margin?
    //   make space for div through editor margin-top
    this.editor.element.style.marginTop = height + 'px'    
    //   move div into the space
    this.element.style.top = '-' + height + 'px'    
    
    console.log('◀ PandocPdfView constructor')
  }
  
  
  // destroy PandocPdfView
  destroy() {
    console.log('▶ PandocPdfView destroy')
    
    this.editor.element.style.marginTop = '0px'
    this.editor.element.removeChild(this.element)
    this.editor = null
    this.element.model = null
    // remove event listeners?
    this.element = null
    this.processor.destroy()
    this.subscriptions.dispose()
    
    console.log('◀ PandocPdfView destroy')
  }
  
  
  // **************************************************************************


  // show or hide "Pandoc/PDF Log" dialog
  showLog(show) {
    console.log('▶ PandocPdfView showLog')
    
    // called without argument? → toggle
    const ppd = this.element.querySelector('.pandoc-pdf-dialog')
    if (show === undefined) {
      show = (ppd.style.display == "none")
    }
    // set "display" property of dialog according to show
    ppd.style.display = show ? 'block' : 'none'
    // add/remove "selected" class to button according to show
    const tl = this.element.querySelector('[data-id="toggle-log"]')
    if (show) {
      tl.classList.add('selected')
    } else {
      tl.classList.remove('selected')
    }
    
    console.log('◀ PandocPdfView showLog')
  }

  
  // wrapper around PandocPdfProcessor functionality,
  // to make it available from pandoc-pdf.js
  process() {
    this.processor.start()
  }
  
}
